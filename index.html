<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Miriam's PacMan Game</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  touch-action: none;
  -webkit-user-select: none;
}

body {
  background: #5c1a2b;
  font-family: monospace;
  text-align: center;
  color: #4a0015;
}

#screen {
  background: #ff9bb3;
  border: 12px solid #4a0015;
  width: 320px;
  height: 450px;
  margin: 20px auto;
  padding: 10px;
  position: relative;
  overflow: hidden;
}

canvas {
  background: #ff9bb3;
  display: block;
  margin: auto;
}

#startScreen, #endScreen {
  position: absolute;
  top:0; left:0;
  width: 100%; height: 100%;
  background: #ff9bb3;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color:#4a0015;
  z-index: 10;
}

#startScreen button {
  font-size: 20px;
  padding: 10px 20px;
  margin-top: 20px;
  background: #FF6F91;
  border: 2px solid #4a0015;
  color: #4a0015;
  border-radius: 4px;
}

/* joystick BELOW game */
#joystick {
  margin: 20px auto;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: black;
  position: relative;
}

#stick {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: yellow;
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
}
</style>
</head>

<body>

<h2 style="font-size:16px;color:black;">Miriam's PacMan</h2>

<div id="screen">

<div>Score: <span id="score">0</span> | Lives: <span id="lives">3</span></div>

<canvas id="game" width="320" height="450"></canvas>

<div id="startScreen">
Hi baby, let's put your Pac-Man skills to the test.<br>
See you on the other side.<br>
Hit START to play
<button onclick="startGame()">START</button>
</div>

<div id="endScreen" style="display:none;"></div>

</div>

<!-- joystick BELOW -->
<div id="joystick">
<div id="stick"></div>
</div>

<script>

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const scoreEl = document.getElementById("score");
const livesEl = document.getElementById("lives");
const startScreen = document.getElementById("startScreen");

const grid = 16;

let score,lives,player,beatFrame,mouthOpen,gameInterval;
let hearts,ghosts,sparkles;

const audioCtx = new (window.AudioContext||window.webkitAudioContext)();

function chompSound(){
  const osc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  osc.type="square";
  osc.frequency.value=500;
  gain.gain.value=.15;
  osc.connect(gain).connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime+.08);
}

function drawHeart(x,y){
  const px=x*grid,py=y*grid;
  const size=3+Math.sin(beatFrame/5)*.7;
  const sprite=[
  [0,1,1,0,1,1,0],
  [1,1,1,1,1,1,1],
  [1,1,1,1,1,1,1],
  [0,1,1,1,1,1,0],
  [0,0,1,1,1,0,0],
  [0,0,0,1,0,0,0]];
  ctx.fillStyle="#FF3333";
  sprite.forEach((r,ri)=>r.forEach((c,ci)=>{
    if(c)ctx.fillRect(px+ci*size,py+ri*size,size,size);
  }));
}

function draw(){
  ctx.clearRect(0,0,320,450);
  hearts.forEach(h=>drawHeart(h.x,h.y));

  const px=player.px+8,py=player.py+8;
  let a=0;
  if(player.dx===1)a=0;
  if(player.dx===-1)a=Math.PI;
  if(player.dy===-1)a=-Math.PI/2;
  if(player.dy===1)a=Math.PI/2;

  ctx.fillStyle="yellow";
  ctx.beginPath();
  ctx.moveTo(px,py);
  ctx.arc(px,py,7,a+.6,a+2*Math.PI-.6);
  ctx.fill();

  ghosts.forEach(g=>{
    ctx.fillStyle=g.color;
    ctx.fillRect(g.px,g.py,14,14);
  });

  sparkles.forEach(s=>{
    ctx.fillStyle="white";
    ctx.fillRect(s.x,s.y,s.size,s.size);
    s.y--;s.size*=.95;
  });

  sparkles=sparkles.filter(s=>s.size>.5);
  beatFrame++;
}

function update(){
  if(!player)return;

  player.px+=player.dx*4;
  player.py+=player.dy*4;

  player.px=Math.max(0,Math.min(304,player.px));
  player.py=Math.max(0,Math.min(434,player.py));

  player.x=Math.floor(player.px/grid);
  player.y=Math.floor(player.py/grid);

  ghosts.forEach(g=>{
    if(!g.tx||Math.random()<.02){
      g.tx=Math.random()*304;
      g.ty=Math.random()*434;
    }
    g.px+=(g.tx-g.px)/20;
    g.py+=(g.ty-g.py)/20;
  });

  checkCollisions();
  draw();
}

function checkCollisions(){

  hearts=hearts.filter(h=>{
    if(h.x===player.x&&h.y===player.y){
      score++;scoreEl.textContent=score;
      chompSound();
      return false;
    }
    return true;
  });

  ghosts.forEach(g=>{
    if(Math.abs(g.px-player.px)<12&&Math.abs(g.py-player.py)<12){
      lives--;livesEl.textContent=lives;
      player.px=160;player.py=200;
      if(lives<=0)gameOver();
    }
  });

  if(score>=15)win();
}

function gameOver(){
  clearInterval(gameInterval);
  ctx.clearRect(0,0,320,450);
  ctx.fillStyle="#4a0015";
  ctx.textAlign="center";
  ctx.font="18px monospace";
  ctx.fillText("Try Again!",160,220);
}

/* STATIC WIN SCREEN */
function win(){
  clearInterval(gameInterval);
  ctx.clearRect(0,0,320,450);

  ctx.fillStyle="#4a0015";
  ctx.textAlign="center";

  ctx.font="28px monospace";
  ctx.fillText("YOU WIN!",160,120);

  ctx.font="32px monospace";
  ctx.fillText("Miriam,",160,200);
  ctx.fillText("Will You Be",160,240);
  ctx.fillText("My Valentine? â™¥",160,280);
}

function startGame(){
  startScreen.style.display="none";

  score=0;lives=3;
  scoreEl.textContent=0;
  livesEl.textContent=3;

  beatFrame=0;mouthOpen=true;

  player={px:160,py:200,dx:0,dy:0};

  hearts=[];
  for(let i=0;i<15;i++)
    hearts.push({x:Math.floor(Math.random()*20),
                 y:Math.floor(Math.random()*28)});

  ghosts=[
  {px:40,py:40,color:"#CC0000"},
  {px:200,py:60,color:"#00FFFF"},
  {px:120,py:300,color:"#FF8000"},
  {px:260,py:200,color:"#FF007F"}];

  sparkles=[];

  clearInterval(gameInterval);
  gameInterval=setInterval(update,50);
  draw();
}

/* joystick */
const joystick=document.getElementById("joystick");
const stick=document.getElementById("stick");

function moveStick(t){
  const r=joystick.getBoundingClientRect();
  let x=t.clientX-(r.left+r.width/2);
  let y=t.clientY-(r.top+r.height/2);

  const absX=Math.abs(x),absY=Math.abs(y);

  if(absX>absY){
    player.dx=x>0?1:-1;player.dy=0;
  }else{
    player.dy=y>0?1:-1;player.dx=0;
  }

  stick.style.transform=`translate(${x/3}px,${y/3}px)`;
}

joystick.addEventListener("touchmove",e=>{
  moveStick(e.touches[0]);
});

joystick.addEventListener("touchend",()=>{
  player.dx=player.dy=0;
  stick.style.transform="translate(-50%,-50%)";
});

document.addEventListener("keydown",e=>{
  if(e.key==="ArrowUp")player.dy=-1,player.dx=0;
  if(e.key==="ArrowDown")player.dy=1,player.dx=0;
  if(e.key==="ArrowLeft")player.dx=-1,player.dy=0;
  if(e.key==="ArrowRight")player.dx=1,player.dy=0;
});

</script>
</body>
</html>
